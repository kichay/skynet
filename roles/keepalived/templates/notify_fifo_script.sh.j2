#!/bin/bash

FIFO=$1

[[ ! -n $FIFO ]] && echo FIFO file not defined && exit 1
[[ ! -p $FIFO ]] && echo FIFO file not found \"$FIFO\" && exit 1

standby() {
  ip link set dev home_dummy master home 2>/dev/null
  ip link set dev isp1_dummy master isp1 2>/dev/null
}

master() {
  ip link set dev home_dummy nomaster 2>/dev/null
  ip link set dev isp1_dummy nomaster 2>/dev/null
}

close() {
  standby
  exit 0
}

trap close TERM HUP INT QUIT USR1 USR2 PIPE ALRM

while read LINE; do

  set $LINE

  [[ $1 = INSTANCE && ${2//\"/} = gateway && $3 = MASTER ]] && master
  [[ $1 = INSTANCE && ${2//\"/} = gateway && $3 = BACKUP ]] && standby
  [[ $1 = INSTANCE && ${2//\"/} = gateway && $3 = FAULT ]] && standby

done < $FIFO

standby
